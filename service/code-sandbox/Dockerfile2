# ------------------------------------------------------------
# Dockerfile (Ubuntu 22.04)
#  - 所有镜像配置来自 mirrors/ 目录
#  - Miniconda 安装脚本通过 miniconda.txt 指定前缀动态拼接
# ------------------------------------------------------------

FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive

ENV LANG=C.UTF-8 \
    TZ=Asia/Shanghai \
    PYTHONDONTWRITEBYTECODE=1

# 1. 安装基础工具
RUN apt-get update -qq \
 && apt-get install -y -qq --no-install-recommends \
      ca-certificates gnupg wget curl \
 && rm -rf /var/lib/apt/lists/*

# 2. 替换 APT 源
COPY mirrors/sources.list /etc/apt/sources.list

# 3. 常用编译调试工具
RUN apt-get update -qq \
 && apt-get install -y -qq --no-install-recommends \
      build-essential curl wget bzip2 git unzip \
      libssl-dev libffi-dev software-properties-common \
      gnupg apt-transport-https dirmngr lsb-release \
      cmake make dos2unix vim \
 && rm -rf /var/lib/apt/lists/*

# 4. Temurin 仓库
RUN mkdir -p /etc/apt/keyrings \
 && wget -qO /etc/apt/keyrings/adoptium.asc \
      https://packages.adoptium.net/artifactory/api/gpg/key/public
COPY mirrors/adoptium.list /etc/apt/sources.list.d/adoptium.list
RUN apt-get update -qq \
 && apt-get install -y -qq --no-install-recommends \
      temurin-8-jdk temurin-17-jdk temurin-21-jdk \
 && rm -rf /var/lib/apt/lists/*

# 5. Python 依赖清单
COPY requirements.txt /opt/requirements.txt

# 6. 复制 miniconda.txt（仅含前缀 URL）
COPY mirrors/miniconda.txt /tmp/miniconda.txt

# 7. 动态拼接并安装 Miniconda
RUN set -e; \
    PREFIX=$(cat /tmp/miniconda.txt | tr -d '\n'); \
    INSTALLER_URL="${PREFIX}/Miniconda3-latest-Linux-x86_64.sh"; \
    wget -qO /tmp/miniconda.sh "${INSTALLER_URL}"; \
    bash /tmp/miniconda.sh -b -p /opt/conda; \
    rm -f /tmp/miniconda.sh /tmp/miniconda.txt

# 8. 配置 .condarc
COPY mirrors/.condarc /root/.condarc
ENV PATH="/opt/conda/bin:${PATH}"
RUN conda update -y -q conda

# 9. 项目脚本可执行权限
COPY install_env.sh /opt/install_env.sh
COPY env_sh/*.sh /opt/env_sh/
COPY mirrors/gcc.txt /opt/gcc.txt
RUN chmod +x /opt/install_env.sh /opt/env_sh/*.sh

# 10. 执行 install_env.sh（内部 pip/conda 已走镜像）
RUN /opt/install_env.sh
